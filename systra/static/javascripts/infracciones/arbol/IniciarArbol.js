// Generated by CoffeeScript 1.6.3
define(['core/sandbox', 'infracciones/arbol/ManagerHistorial', 'perfil/IniciarListPerfil'], function(sandbox, mh, iniciar_lista_perfil) {
  var app;
  return app = {
    block_add: false,
    iniciar: function() {
      var that;
      that = this;
      this.sandbox = new sandbox(this);
      mh.iniciar();
      that.colapsarComandancias();
      $(".view-profile-historial-folios").on('click', function(evento) {
        var her, id, ident;
        ident = evento.currentTarget.id;
        her = ident.split('_');
        id = her[1];
        return that.showProfileHistorialFolios(id);
      });
      $("#todos_profiles").change(function() {
        var id;
        id = $(this).val();
        if (id === "NO") {
          that.limpiarElemento();
          return;
        }
        that.showProfileHistorialFolios(id);
      });
      $("#list-4ta").on('click', function(evento) {
        return that.cargarComandancia("4TA");
      });
      $("#list-10ma").on('click', function(evento) {
        return that.cargarComandancia("10MA");
      });
      $("#list-feria").on('click', function(evento) {
        return that.cargarComandancia("FERIA");
      });
      $("#list-5ta").on('click', function(evento) {
        return that.cargarComandancia("5TA");
      });
      $("#list-7ma").on('click', function(evento) {
        return that.cargarComandancia("7MA");
      });
      $("#list-6ta").on('click', function(evento) {
        return that.cargarComandancia("6TA");
      });
      $("#list-3ra").on('click', function(evento) {
        return that.cargarComandancia("3RA");
      });
      $("#list-9na").on('click', function(evento) {
        return that.cargarComandancia("9NA");
      });
      $("#list-8va").on('click', function(evento) {
        return that.cargarComandancia("8VA");
      });
      $("#list-1ra").on('click', function(evento) {
        return that.cargarComandancia("1RA");
      });
      $("#list-2da").on('click', function(evento) {
        return that.cargarComandancia("2DA");
      });
      window.IniciarArbol = this;
      $('#lista-perfil').on('click', function(evento) {
        return that.showListPerfil();
      });
    },
    showListPerfil: function() {
      $.ajax({
        type: "GET",
        url: '/perfil/list',
        dataType: 'html',
        success: function(res) {
          $("#fichas-infracciones").html(res);
          return iniciar_lista_perfil.iniciar();
        }
      });
    },
    cargarComandancia: function(comandancia) {
      var that;
      that = this;
      $.ajax({
        type: "GET",
        url: '/folios/list_comandancia/' + comandancia + '/',
        dataType: 'html',
        success: function(res) {
          return $("#fichas-infracciones").html(res);
        },
        error: function(error) {
          return that.showMensajeError(error.responseText);
        }
      });
    },
    colapsarComandancias: function() {
      var children, com, comandancias, _i, _len, _results;
      comandancias = ["#span-1ra", "#span-10ma", "#span-2da", "#span-3ra", "#span-4ta", "#span-5ta", "#span-6ta", "#span-7ma", "#span-8va", "#span-9na"];
      _results = [];
      for (_i = 0, _len = comandancias.length; _i < _len; _i++) {
        com = comandancias[_i];
        children = $(com).parent('li.parent_li').find(" > ul > li");
        if (children.is(":visible")) {
          children.hide("fast");
          _results.push($(this).attr("title", "Expande esta rama").find(" > i").addClass("icon-plus-sign").removeClass("icon-minus-sign"));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    },
    iniciarHistorial: function() {
      var that;
      that = window.IniciarArbol;
      that.actualizarAddBlocHistory();
      $('#guardar_inf').on('click', function(evento) {
        return that.agregarFolio();
      });
      $("#agregar-bloque").on('click', function(evento) {
        if (that.block_add) {
          that.block_add = false;
          that.sandbox.emit('hidden-add-block');
          return that.sandbox.emit('show-history-block');
        } else {
          that.sandbox.emit('show-add-block');
          that.sandbox.emit('hidden-history-block');
          return that.block_add = true;
        }
      });
      $('.view-detail-block').on('click', function(evento) {
        var her, id, ident;
        ident = evento.currentTarget.id;
        her = ident.split('_');
        id = her[1];
        if ($("#" + ident).html() === "Ver detalles »") {
          $("#" + ident).html("Ocultar detalles «");
          return that.cargarDetailBlock(id);
        } else {
          $("#" + ident).html("Ver detalles »");
          return $("#detailblock-" + id).html('');
        }
      });
      return $('.remove-block').on('click', function(evento) {
        var her, id, ident;
        ident = evento.currentTarget.id;
        her = ident.split('_');
        id = her[1];
        return that.removeBlock(id);
      });
    },
    removeBlock: function(id) {
      var that;
      that = this;
      $.ajax({
        type: "GET",
        url: '/folios/borrar_block/' + id + '/',
        dataType: 'json',
        success: function(res) {
          var folio;
          folio = $('#view_cobro').html();
          return that.showProfileHistorialFolios(folio);
        },
        error: function(error) {
          return that.showMensajeError(error.responseText);
        }
      });
    },
    agregarFolio: function() {
      var currentTime, datos, day, dd, desde, fecha, folio, hasta, month, that, year;
      that = this;
      folio = $('#folio').val();
      desde = $('#desde-folio').val();
      hasta = $('#asta-folio').val();
      currentTime = new Date();
      month = currentTime.getMonth() + 1;
      day = currentTime.getDate();
      year = currentTime.getFullYear();
      fecha = year + "-" + month + "-" + day;
      datos = {
        folio: folio,
        desde: desde,
        hasta: hasta,
        fecha: fecha
      };
      dd = {
        data: JSON.stringify(datos)
      };
      $.post('/folios/add', dd, function(data) {
        var status;
        status = data.status;
        if (status === "OK") {
          that.showMensaje('Se guardo el block <span class="new-folio">' + data.data.no_blocks + '</span> exitosamente!!!');
        } else {
          that.showMensaje(data.msg);
        }
        console.log(data);
        that.refrescarHistory(data.data.num_cobro_agente);
        return that.cancelar();
      });
    },
    cancelar: function() {
      $('#desde-folio').val("");
      return $('#asta-folio').val("");
    },
    refrescarHistory: function(cobro) {
      return console.log("Hola mundo");
    },
    limpiarElemento: function() {
      return $("#fichas-infracciones").html("");
    },
    actualizarAddBlocHistory: function() {
      var that;
      that = window.IniciarArbol;
      if (this.block_add) {
        that.sandbox.emit('show-add-block');
        return that.sandbox.emit('hidden-history-block');
      } else {
        that.sandbox.emit('hidden-add-block');
        return that.sandbox.emit('show-history-block');
      }
    },
    showProfileHistorialFolios: function(id) {
      var that;
      that = this;
      that.iniciarSpiner();
      $.ajax({
        type: "GET",
        url: '/folios/profile_historial_folios/' + id + '/',
        dataType: 'html',
        success: function(res) {
          $("#fichas-infracciones").html(res);
          that.iniciarHistorial();
          return window.spinner.stop();
        },
        error: function(error) {
          window.spinner.stop();
          return that.showMensajeError(error.responseText);
        }
      });
    },
    cargarDetailBlock: function(id) {
      var that;
      that = this;
      that.iniciarSpiner();
      $.ajax({
        type: "GET",
        url: '/folios/get_detail_from_folio/' + id + '/',
        dataType: 'html',
        success: function(res) {
          $("#detailblock-" + id).html(res);
          return window.spinner.stop();
        },
        error: function(error) {
          window.spinner.stop();
          return that.showMensajeError(error.responseText);
        }
      });
    },
    showMensajeError: function(msg) {
      var $div;
      $div = $('#myErrorModal .modal-body').html(msg);
      $("#myErrorModal").modal('show');
      return $('#myErrorModalLabel').html('ERROR');
    },
    showMensaje: function(titulo, msg, fn, sandbox) {
      var $div;
      $div = $('#myModal .modal-body').html(msg);
      $("#myModal").modal('show');
      $('#myModalLabel').html(titulo);
      if (fn) {
        fn(sandbox);
        return window.spinner.stop();
      }
    },
    iniciarSpiner: function() {
      var opts, target;
      opts = {
        lines: 13,
        length: 20,
        width: 10,
        radius: 30,
        corners: 1,
        rotate: 0,
        direction: 1,
        color: '#000',
        speed: 1,
        trail: 60,
        shadow: false,
        hwaccel: false,
        className: 'spinner',
        zIndex: 2e9,
        top: 'auto',
        left: 'auto'
      };
      target = document.getElementById('loading');
      window.spinner = new Spinner(opts).spin(target);
      return target.appendChild(window.spinner.el);
    }
  };
});

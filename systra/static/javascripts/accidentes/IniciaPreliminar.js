// Generated by CoffeeScript 1.6.3
define(['core/sandbox', 'accidentes/ManagerMenuPreliminar'], function(sandbox, modMenuPreliminar) {
  var IniciaPreliminar;
  return IniciaPreliminar = {
    padre: null,
    tblTabla: null,
    tabla: null,
    CARGAR_EN_VIEW: "cargar-preliminar-en-view",
    CARGAR_EN_VIEW_FROM_SERVER: "cargar-preliminar-en-view-from-server",
    CLEAR_VIEW: "clear-preliminar-en-view",
    observaciones: null,
    cargar_inicia: true,
    menu_oculto: false,
    spinner: null,
    iniciar: function() {
      var that;
      that = this;
      this.iniciarSpiner();
      this.sandbox = new sandbox(this);
      window.refsync = window.ip_sys_msg;
      window.client = io.connect(window.refsync);
      modMenuPreliminar.iniciar();
      this.sandbox.on(this.CARGAR_EN_VIEW, window.loadOnView);
      this.sandbox.on(this.CARGAR_EN_VIEW_FROM_SERVER, this.loadOnViewFromServer);
      this.observaciones = $('#observaciones_pre').wysihtml5();
      this.llenarProfile();
      this.iniciarDate();
      setModulo('accidente');
      $('#delegacion_pre').on('change', function(evento) {
        var valor;
        valor = $('#' + evento.currentTarget.id).val();
        window.actualizarComandanciaValor(valor);
      });
      $('#cerrar-menu').on('click', function(evento) {
        return that.ocultar_menu();
      });
      window.cargarSelects();
      loadOnView();
      this.padre = $('#contenido');
      if (!window.preliminar) {
        this.reiniciarPreliminar();
      } else {
        loadOnView();
      }
      this.observaciones = $('#observaciones_pre').wysihtml5();
      $('#guardar_preliminar_pre').on('click', function() {
        that.agregarPreliminar();
      });
      $('#cancelar_preliminar_pre').on('click', function() {
        that.cancelar();
      });
      $(document).keypress('ctrl+l', function(evento) {
        if (evento.ctrlKey) {
          if (evento.charCode === 16) {
            that.showSelReporte(that);
          } else if (evento.charCode === 12) {
            that.agregarPreliminar();
          }
        }
      });
      $('#mostrar-lista-preliminar').on('click', function() {
        that.ocultarCaptura();
        return that.showLista(that.iniciarCalendarioLista);
      });
      iniciarMenu();
    },
    iniciarCalendarioLista: function() {
      $('#fecha-inicia-append').datetimepicker({
        pickTime: false,
        language: 'es'
      });
      return $('#fecha-final-append').datetimepicker({
        pickTime: false,
        language: 'es'
      });
    },
    iniciarDate: function() {
      return Date.prototype.format = function(fstr, utc) {
        var pre, that;
        that = this;
        if (utc) {
          pre = 'getUTC';
        } else {
          pre = 'get';
        }
        return fstr.replace(/%[YmdHMS]/g, function(m) {
          switch (m) {
            case '%Y':
              return that[pre + 'FullYear']();
            case '%m':
              m = 1 + that[pre + 'Month']();
              break;
            case '%d':
              m = that[pre + 'Date']();
              break;
            case '%H':
              m = that[pre + 'Hours']();
              break;
            case '%M':
              m = that[pre + 'Minutes']();
              break;
            case '%S':
              m = that[pre + 'Seconds']();
              break;
            default:
              return m.slice(1);
          }
          return ('0' + m).slice(-2);
        });
      };
    },
    iniciarSpiner: function() {
      var opts, target;
      opts = {
        lines: 13,
        length: 20,
        width: 10,
        radius: 30,
        corners: 1,
        rotate: 0,
        direction: 1,
        color: '#000',
        speed: 1,
        trail: 60,
        shadow: false,
        hwaccel: false,
        className: 'spinner',
        zIndex: 2e9,
        top: 'auto',
        left: 'auto'
      };
      target = document.getElementById('loading');
      window.spinner = new Spinner(opts).spin(target);
      return target.appendChild(window.spinner.el);
    },
    llenarProfile: function() {
      if (!window.profile) {
        return cargarProfile(this.llenarProfile);
      } else {

      }
    },
    ocultar_menu: function() {
      if (this.menu_oculto) {
        this.menu_oculto = false;
        $('ul.nav').hide();
        $('#cerrar-menu').html('');
        return $('#cerrar-menu').append('<i class="icon-plus-sign"/>');
      } else {
        this.menu_oculto = true;
        $('ul.nav').show();
        $('#cerrar-menu').html('');
        return $('#cerrar-menu').append('<i class="icon-minus-sign"/>');
      }
    },
    cancelar: function() {
      this.limpiarColorFields();
      $("#folio_pre").val('');
      $("#fecha_preliminar").val('');
      $("#hora_preliminar").val('');
      $('#delegacion_pre').val('');
      $("#comandancia_pre").val('');
      $("#turno_pre").val('');
      $("#tipo_evento_pre").val('');
      $("#clasificacion_pre").val('');
      $("#calle1_pre").val('');
      $("#calle2_pre").val('');
      $("#ref_pre").val('');
      $("#colonia_pre").val('');
      $("#operativo_pre").val('');
      $("#no_vehiculos_pre").val('');
      $("#no_detenidos_pre").val('');
      $("#no_heridos_pre").val('');
      $("#no_muertos_pre").val('');
      $("#pension_pre").val('');
      $("#no_de_inventario_pre").val('');
      $("#cobro_agente_pre").val('');
      $("#nombre_agente_pre").val('');
      $("#gafete_agente_pre").val('');
      $("#unidad_pre").val('');
      $("#sector_pre").val('');
      return this.limpiarObservaciones();
    },
    loadOnViewFromServer: function(id) {
      var that, url;
      that = this;
      url = '/accidente/getPreliminar/' + id + "/";
      that = this;
      return $.ajax({
        type: 'GET',
        url: url,
        success: function(data) {
          window.preliminar = data;
          console.log(data);
          loadOnView();
        }
      });
      /*area1=$('#observaciones_pre').data('wysihtml5')*/

    },
    limpiarObservaciones: function() {
      this.observaciones.val('');
    },
    appendObservaciones: function(data) {
      var w5ref;
      w5ref = this.observaciones.data('wysihtml5');
      if (w5ref) {
        w5ref.editor.setValue(data);
      } else {
        this.observaciones.html(data);
      }
    },
    llenarObservacionesPreliminar: function(data) {
      var preliminar, w5ref;
      preliminar = window.preliminar;
      w5ref = this.observaciones.data('wysihtml5');
      if (w5ref) {
        preliminar.observaciones_evento = w5ref.editor.getValue();
      } else {
        preliminar.observaciones_evento = this.observaciones.html();
      }
    },
    agregarToMenu: function() {
      var a_preliminares, acc_preliminar, obj, preliminar, preliminares;
      acc_preliminar = sessionStorage.getItem('preliminares-server');
      preliminar = window.preliminar;
      if (!acc_preliminar) {
        preliminares = [];
        preliminares.push(preliminar);
        obj = JSON.stringify(preliminares);
        sessionStorage.setItem('preliminares-server', obj);
        return this.sandbox.emit('update-menu-preliminar-server', preliminares);
      } else {
        a_preliminares = JSON.parse(acc_preliminar);
        if (a_preliminares.length > 5) {
          a_preliminares.shift();
        }
        a_preliminares.push(preliminar);
        obj = JSON.stringify(a_preliminares);
        sessionStorage.setItem('preliminares-server', obj);
        return this.sandbox.emit('update-menu-preliminar-server', a_preliminares);
      }
    },
    showFieldError: function(item, msg) {
      var padre;
      padre = item.parents("div.control-group");
      padre.addClass('error');
      padre.children('.help-inline').html(msg);
      return item.focus();
    },
    showFieldSuccess: function(item) {
      var padre;
      padre = item.parents("div.control-group");
      padre.addClass('success');
      return padre.children('.help-inline').html('');
    },
    limpiarColorFields: function() {
      $(".control-group").removeClass('error');
      return $(".control-group").removeClass('success');
    },
    validateFields: function() {
      var gafete_intervino, res, rr, that, unidad, val_calle1, val_calle2, val_colonia;
      this.limpiarColorFields();
      that = this;
      if ($("#fecha_preliminar").val() === '') {
        this.showFieldError($("#fecha_preliminar"), "Debes elegir la fecha");
        return false;
      } else {
        this.showFieldSuccess($("#fecha_preliminar"));
      }
      if ($("#hora_preliminar").val() === '') {
        this.showFieldError($("#hora_preliminar"), "Debes elegir la hora");
        return false;
      } else {
        this.showFieldSuccess($("#hora_preliminar"));
      }
      if ($("#delegacion_pre").val() === 'NO') {
        this.showFieldError($("#delegacion_pre"), "Debes elegir una opción");
        return false;
      } else {
        this.showFieldSuccess($("#delegacion_pre"));
      }
      if ($("#comandancia_pre").val() === 'NO') {
        this.showFieldError($("#comandancia_pre"), "Debes elegir una opción");
        return false;
      } else {
        this.showFieldSuccess($("#comandancia_pre"));
      }
      if ($("#turno_pre").val() === 'NO') {
        this.showFieldError($("#turno_pre"), "Debes elegir una opción");
        return false;
      } else {
        this.showFieldSuccess($("#turno_pre"));
      }
      if ($("#tipo_evento_pre").val() === 'NO') {
        this.showFieldError($("#tipo_evento_pre"), "Debes elegir una opción");
        return false;
      } else {
        this.showFieldSuccess($("#tipo_evento_pre"));
      }
      if ($("#clasificacion_pre").val() === 'NO') {
        this.showFieldError($("#clasificacion_pre"), "Debes elegir una opción");
        return false;
      } else {
        this.showFieldSuccess($("#clasificacion_pre"));
      }
      val_calle1 = $('#calle1_pre').val();
      if (val_calle1 === '') {
        this.showFieldError($("#calle1_pre"), "Debes elegir una calle");
        return false;
      } else {
        rr = window.validateCalle(val_calle1);
        if (!rr.res) {
          this.showFieldError($("#calle1_pre"), rr.msg);
          return false;
        } else {
          this.showFieldSuccess($("#calle1_pre"));
        }
      }
      val_calle2 = $('#calle2_pre').val();
      if (val_calle2 !== '') {
        rr = window.validateCalle(val_calle2);
      }
      if (!rr.res) {
        this.showFieldError($("#calle2_pre"), rr.msg);
        return false;
      } else {
        this.showFieldSuccess($("#calle2_pre"));
      }
      val_colonia = $('#colonia_pre').val();
      if (val_colonia === '') {
        this.showFieldError($("#colonia_pre"), "Debes elegir una colonia");
        return false;
      } else {
        rr = window.validateColonia(val_colonia);
        if (!rr.res) {
          this.showFieldError($("#colonia_pre"), rr.msg);
          return false;
        } else {
          this.showFieldSuccess($("#colonia_pre"));
        }
      }
      if ($("#operativo_pre").val() === 'NO') {
        this.showFieldError($("#operativo_pre"), "Debes elegir una opción");
        return false;
      } else {
        this.showFieldSuccess($("#operativo_pre"));
      }
      if ($("#no_vehiculos_pre").val() === '') {
        this.showFieldError($("#no_vehiculos_pre"), "Es necesario especificar el número de vehículos");
        return false;
      } else {
        this.showFieldSuccess($("#no_vehiculos_pre"));
      }
      res = window.validateInt($("#no_vehiculos_pre").val(), 0, Number.MAX_VALUE);
      if (!res.res) {
        this.showFieldError($("#no_vehiculos_pre"), res.msg);
        return false;
      } else {
        this.showFieldSuccess($("#no_vehiculos_pre"));
      }
      if ($("#no_detenidos_pre").val() === '') {
        this.showFieldError($("#no_detenidos_pre"), "Es necesario especificar el número de vehículos");
        return false;
      } else {
        this.showFieldSuccess($("#no_detenidos_pre"));
      }
      res = window.validateInt($("#no_detenidos_pre").val(), 0, Number.MAX_VALUE);
      if (!res.res) {
        this.showFieldError($("#no_detenidos_pre"), res.msg);
        return false;
      } else {
        this.showFieldSuccess($("#no_detenidos_pre"));
      }
      if ($("#no_heridos_pre").val() === '') {
        this.showFieldError($("#no_heridos_pre"), "Es necesario especificar el número de vehículos");
        return false;
      } else {
        this.showFieldSuccess($("#no_heridos_pre"));
      }
      res = window.validateInt($("#no_heridos_pre").val(), 0, Number.MAX_VALUE);
      if (!res.res) {
        this.showFieldError($("#no_heridos_pre"), res.msg);
        return false;
      } else {
        this.showFieldSuccess($("#no_heridos_pre"));
      }
      if ($("#no_vehiculos_pre").val() === '') {
        this.showFieldError($("#no_muertos_pre"), "Es necesario especificar el número de vehículos");
        return false;
      } else {
        this.showFieldSuccess($("#no_muertos_pre"));
      }
      res = window.validateInt($("#no_muertos_pre").val(), 0, Number.MAX_VALUE);
      if (!res.res) {
        this.showFieldError($("#no_muertos_pre"), res.msg);
        return false;
      } else {
        this.showFieldSuccess($("#no_muertos_pre"));
      }
      if ($("#pension_pre").val() === 'NO') {
        this.showFieldError($("#pension_pre"), "Debes elegir una opción");
        return false;
      } else {
        this.showFieldSuccess($("#pension_pre"));
      }
      gafete_intervino = $('#gafete_agente_pre').val();
      if (gafete_intervino === '') {
        this.showFieldError($("#gafete_agente_pre"), "Debes elegir el número del Elemento");
        return false;
      } else {
        rr = window.validateAgente(gafete_intervino);
        if (rr.res === false) {
          this.showFieldError($("#gafete_agente_pre"), res.msg);
          return false;
        } else {
          this.showFieldSuccess($("#gafete_agente_pre"));
        }
      }
      unidad = $('#unidad_pre').val();
      if (unidad === '') {
        this.showFieldError($("#unidad_pre"), "Debes elegir una unidad");
        return false;
      } else {
        rr = window.validateUnidad(unidad);
        if (!rr.res) {
          this.showFieldError($("#unidad_pre"), res.msg);
          return false;
        } else {
          this.showFieldSuccess($("#intervino_pre"));
        }
      }
      that.llenarObservacionesPreliminar();
      return true;
    },
    agregarPreliminar: function() {
      var that;
      that = this;
      this.actualizarPreliminar();
      if (!this.validateFields()) {
        return;
      }
      $.ajax({
        data: window.preliminar,
        type: "POST",
        url: '/accidente/crearPreliminar/',
        success: function(data) {
          var a, dd, noticia, pre;
          window.preliminar.id = data.id;
          pre = window.preliminar;
          window.preliminar.folio_evento = data.folio_evento;
          that.agregarToMenu();
          a = new Date();
          noticia = {
            titulo: data.folio_evento + "    " + pre.clasificacion_de_accidente + "   " + pre.calle1 + "    " + pre.agente,
            noticia: "",
            tags: "Preliminar",
            archivos: "/static/fotos_subidas/foto.jpg",
            capturado_por: window.profile.nombre,
            fecha: a.format("%Y-%m-%d %H:%M:%S", true)
          };
          dd = {
            noticia: noticia,
            last_folio: data.folio_evento
          };
          window.client.emit('add-new-preliminar', dd);
          that.cancelar();
          return that.showMensaje('Se guardo el preliminar con numero de folio <span class="new-folio">' + data.folio_evento + '</span> exitosamente!!!');
        }
      });
    },
    showMensaje: function(msg) {
      var $div;
      $div = $('#myModal .modal-body').html(msg);
      return $("#myModal").modal('show');
    },
    showCancelarPreliminar: function(id) {
      var that;
      that = this;
      return $.get('accidente/pantallas/cancelar_preliminar/', function(data) {
        return that.showMensaje(data);
      });
    },
    ocultarCaptura: function() {
      var cambios, el;
      el = $(".pantalla-captura");
      cambios = {
        height: "0px",
        width: "auto",
        height: "0",
        margin: "0 0 0 0",
        padding: "0",
        overflow: "hidden",
        transition: "all 2s ease"
      };
      return el.css(cambios);
    },
    ocultarLista: function() {
      var cambios, el;
      el = $("#pantalla-lista");
      cambios = {
        height: "0px",
        "min-height": "0px",
        margin: "0 0 0 0",
        padding: "0",
        width: "auto",
        overflow: "hidden",
        transition: "all 2s ease"
      };
      return el.css(cambios);
    },
    showCaptura: function() {
      var cambios, el;
      el = $(".pantalla-captura");
      cambios = {
        height: "auto",
        width: "98%",
        margin: "0 10px 0 10px",
        transition: "all 2s ease"
      };
      return el.css(cambios);
    },
    showLista: function(fn) {
      var that;
      that = this;
      return $.get('/accidente/soloListaPreliminares', function(data) {
        var cambios, el;
        $("#pantalla-lista").html(data);
        $('#mostrar-captura-preliminar').on('click', function(evento) {
          that.ocultarLista();
          return that.showCaptura();
        });
        cambios = {
          width: "98%",
          height: "700px",
          "min-height": "700px",
          margin: "0 10px 0 10px",
          transition: "all 2s ease"
        };
        el = $("#pantalla-lista").css(cambios);
        return fn();
      });
    },
    actualizarPreliminar: function() {
      var preliminar, that;
      that = this;
      preliminar = window.preliminar = {};
      preliminar.fecha = $("#fecha_preliminar").val();
      preliminar.hora = $("#hora_preliminar").val();
      preliminar.numero_de_folio = $("#folio_pre").val();
      preliminar.delegacion = $("#delegacion_pre").val();
      preliminar.comandancia = $("#comandancia_pre").val();
      preliminar.turno = $("#turno_pre").val();
      preliminar.tipo_de_evento = $("#tipo_evento_pre").val();
      preliminar.clasificacion_de_accidente = $("#clasificacion_pre").val();
      preliminar.calle1 = $("#calle1_pre").val();
      preliminar.calle2 = $("#calle2_pre").val();
      preliminar.ref = $("#ref_pre").val();
      preliminar.colonia = $("#colonia_pre").val();
      preliminar.operativo = $("#operativo_pre").val();
      preliminar.no_vehiculos_participantes = $("#no_vehiculos_pre").val();
      preliminar.no_de_detenidos = $("#no_detenidos_pre").val();
      preliminar.no_de_heridos = $("#no_heridos_pre").val();
      preliminar.no_de_muertos = $("#no_muertos_pre").val();
      preliminar.pension = $("#pension_pre").val();
      preliminar.no_de_inventario = $("#no_de_inventario").val();
      preliminar.nombre_agente = $("#nombre_intervino_pre").val();
      preliminar.gafete_agente = $("#gafete_intervino_pre").val();
      preliminar.unidad = $("#unidad_pre").val();
      preliminar.sector = $("#sector_pre").val();
      return this.llenarObservacionesPreliminar();
    },
    reiniciarPreliminar: function() {
      return window.preliminar = {};
    },
    cargarPreliminar: function(fn) {
      var that;
      that = this;
      $.ajax({
        type: 'GET',
        url: 'listaPreliminares.json',
        success: function(data) {
          fn(data);
        }
      });
    }
  };
});
